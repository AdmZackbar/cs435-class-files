<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
    <title>Zach Wassynger - CS 435 - Project #7</title>
    <script id="vertex-shader" type="x-shader/x-vertex">
        #define MAX_LIGHTS 3

        precision mediump float;

        attribute vec4 vPosition;
        attribute vec3 vNormal;

        uniform mat4 projectionMatrix, modelViewMatrix;
        uniform vec3 viewPosition;
        uniform struct Light
        {
            vec4 position;
            bool isActive;
            vec4 ambient;
            vec4 diffuse;
            vec4 specular;
            float shininess;
            float attenuationCoef;
        } lights[MAX_LIGHTS];

        varying vec3 normal, surfaceToView;
        varying vec3 surfaceToLight[MAX_LIGHTS];
        
        void main()
        {
            normal = vNormal;
            surfaceToView = viewPosition - vPosition.xyz;
            for (int i=0; i<MAX_LIGHTS; i++)
            {
                surfaceToLight[i] = (lights[i].position - vPosition).xyz;
            }

            gl_Position = projectionMatrix * modelViewMatrix * vPosition;
        }
    </script>
    <script id="fragment-shader" type="x-shader/x-fragment">
        #define MAX_LIGHTS 3
        
        precision mediump float;

        uniform struct Light
        {
            vec4 position;
            bool isActive;
            vec4 ambient;
            vec4 diffuse;
            vec4 specular;
            float shininess;
            float attenuationCoef;
        } lights[MAX_LIGHTS];
        uniform struct Material
        {
            vec4 ambient;
            vec4 diffuse;
            vec4 specular;
        } material;

        varying vec3 normal, surfaceToView;
        varying vec3 surfaceToLight[MAX_LIGHTS];

        vec4 applyLight(Light light, vec3 normal, vec3 surfaceToView, vec3 surfaceToLight)
        {
            float attenuation;
            vec3 surfaceToLightDir;

            if (light.position.w == 0.0)    // Directional light
            {
                surfaceToLightDir = normalize(light.position.xyz);
                attenuation = 1.0;
            } else
            {
                float distanceToLight = length(surfaceToLight);
                attenuation = 1.0 / (1.0 + light.attenuationCoef*distanceToLight*distanceToLight);

                surfaceToLightDir = normalize(surfaceToLight);
            }
            
            vec3 halfVector = normalize(surfaceToLightDir + surfaceToView);

            float Kd = dot(surfaceToLightDir, normal);
            vec4 diffuse = max(Kd, 0.0) * light.diffuse * material.diffuse;

            float Ks = pow(max(dot(normal, halfVector), 0.0), light.shininess);
            vec4 specular = Ks * light.specular * material.specular;
            
            if(Kd < 0.0) {
                specular = vec4(0.0, 0.0, 0.0, 1.0);
            }

            return (light.ambient*material.ambient) + attenuation*(diffuse + specular);
        }

        void main()
        {
            vec3 normalDir = normalize(normal);
            vec3 surfaceToViewDir = normalize(surfaceToView);

            vec4 fColor = vec4(0);
            for (int i=0; i<3; i++)
            {
                if (lights[i].isActive)
                    fColor += applyLight(lights[i], normalDir, surfaceToViewDir, surfaceToLight[i]);
            }

            fColor.a = 1.0;
            gl_FragColor = fColor;
        }
    </script>
    <script type="text/javascript" src="../Common/webgl-utils.js"></script>
    <script type="text/javascript" src="../Common/initShaders.js"></script>
    <script type="text/javascript" src="../Common/MV.js"></script>
    <script type="text/javascript" src="proj7.js"></script>
</head>
<body>
    <canvas id="gl-canvas" width="1024" height="576">
    Canvas was not loaded - Brower does not support HTML5.
    </canvas>
</body>
</html>
